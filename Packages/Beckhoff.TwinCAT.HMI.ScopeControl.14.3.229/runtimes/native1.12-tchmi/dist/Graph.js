import{GraphType,FillMode,LineState}from"./Types.js";export class LineGraph{__canvas;__context;__points=null;__zeroPoint=null;__lineSeries=null;__graphLayout;__gridSizeLayout;constructor(canvas,graphLayout,gridSize){this.__canvas=canvas,this.__context=this.__canvas.getContext("2d"),this.__graphLayout=graphLayout,this.__gridSizeLayout=gridSize}draw(){if(this.__context&&this.__canvas&&this.__points&&this.__points.length>0&&this.__graphLayout){if(this.__graphLayout.lineColor&&this.__graphLayout.lineWidth)if(this.__context.strokeStyle=this.__graphLayout.lineColor,this.__context.lineWidth=this.__graphLayout.lineWidth,this.__context.lineCap="butt",this.__context.globalAlpha=1,this.__context.setLineDash([]),this.__graphLayout.graphType===GraphType.Bar){if(this.__zeroPoint){this.__context.beginPath();for(let i=0,ii=this.__points.length;i<ii;i++)this.__context.moveTo(this.__points[i].x,this.__zeroPoint.y),this.__context.lineTo(this.__points[i].x,this.__points[i].y);this.__context.stroke()}}else if(this.__graphLayout.graphType===GraphType.ExtendedLine&&this.__lineSeries){this.__context.save();let start=0,end=this.__points.length,current="";for(let i=0,ii=this.__lineSeries.length;i<ii&&!(this.__lineSeries[i].index>=this.__points.length);i++){let lineStates=this.__lineSeries[i].lineStates.filter(ls=>1===parseInt(ls[14],16)),next=0===lineStates.length?"":lineStates[0];""!==next&&next!==current&&(this.__lineSeries[i].index>start&&(end=this.__lineSeries[i].index,this.__renderLineSegment(start,end,current)),start=this.__lineSeries[i].index,current=next)}start<this.__points.length-1&&this.__renderLineSegment(start,this.__points.length-1,current)}else if(this.__graphLayout.graphType===GraphType.RoundShape){if(this.__points.length>=7){let startAngle=Math.ceil(Math.atan2(this.__points[5].y-this.__points[0].y,this.__points[5].x-this.__points[0].x)*(180/Math.PI)),sweepAngle=Math.ceil(Math.atan2(this.__points[6].y-this.__points[0].y,this.__points[6].x-this.__points[0].x)*(180/Math.PI));this.__context.beginPath(),startAngle===sweepAngle?this.__context.ellipse(this.__points[0].x,this.__points[0].y,(this.__points[1].x-this.__points[3].x)/2,(this.__points[4].y-this.__points[2].y)/2,0,0,2*Math.PI):(this.__context.ellipse(this.__points[0].x,this.__points[0].y,(this.__points[1].x-this.__points[3].x)/2,(this.__points[4].y-this.__points[2].y)/2,0,startAngle*Math.PI/180,sweepAngle*Math.PI/180,!0),this.__graphLayout.fillColor&&this.__graphLayout.fillTransparency&&(this.__context.moveTo(this.__points[5].x,this.__points[5].y),this.__context.lineTo(this.__points[0].x,this.__points[0].y),this.__context.lineTo(this.__points[6].x,this.__points[6].y))),this.__context.stroke()}}else if(this.__graphLayout.graphType!==GraphType.MarksOnly){this.__context.beginPath();for(let i=0,ii=this.__points.length;i<ii;i++)0===i?this.__context.moveTo(this.__points[i].x,this.__points[i].y):(this.__graphLayout.graphType===GraphType.Stair&&this.__context.lineTo(this.__points[i].x,this.__points[i-1].y),this.__context.lineTo(this.__points[i].x,this.__points[i].y));this.__context.stroke()}if(this.__graphLayout.fillColor&&this.__graphLayout.fillTransparency)if(this.__context.lineWidth=0,this.__context.fillStyle=this.__graphLayout.fillColor,this.__context.strokeStyle=this.__graphLayout.lineColor,this.__context.globalAlpha=this.__graphLayout.fillTransparency/255,this.__graphLayout.graphType===GraphType.ExtendedLine&&this.__lineSeries){this.__context.save();let start=this.__points.length-1,end=0,current="1";for(let i=this.__lineSeries.length-1,ii=0;i>=ii;i--)this.__lineSeries[i].lineStates.filter(ls=>2===parseInt(ls[14],16))&&(current=this.__lineSeries[i].lineStates.find(ls=>2===parseInt(ls[14],16)),end=this.__lineSeries[i].index,this.__renderFillSegment(start,end,current),start=end);start>0&&this.__renderFillSegment(start,this.__points.length-1,current)}else if(this.__graphLayout.fillMode===FillMode.FromTop)this.__context.lineTo(this.__points[this.__points.length-1].x,this.__gridSizeLayout.position.y),this.__context.lineTo(this.__points[0].x,this.__gridSizeLayout.position.y),this.__context.lineTo(this.__points[0].x,this.__points[0].y),this.__context.fill();else if(this.__graphLayout.fillMode===FillMode.FromBottom)this.__context.lineTo(this.__points[this.__points.length-1].x,this.__gridSizeLayout.position.y+this.__gridSizeLayout.dimensions.height),this.__context.lineTo(this.__points[0].x,this.__gridSizeLayout.position.y+this.__gridSizeLayout.dimensions.height),this.__context.lineTo(this.__points[0].x,this.__points[0].y),this.__context.fill();else if(this.__graphLayout.fillMode===FillMode.FromHorizontalZero)this.__zeroPoint&&(this.__context.lineTo(this.__points[this.__points.length-1].x,this.__zeroPoint.y),this.__context.lineTo(this.__points[0].x,this.__zeroPoint.y),this.__context.fill());else if(this.__graphLayout.fillMode===FillMode.FromCenter){if(this.__zeroPoint)for(let i=0,ii=this.__points.length-1;i<ii;i++)this.__context.beginPath(),this.__context.moveTo(this.__points[i].x,this.__points[i].y),this.__context.lineTo(this.__points[i+1].x,this.__points[i+1].y),this.__context.lineTo(this.__zeroPoint.x,this.__zeroPoint.y),this.__context.closePath(),this.__context.fill()}else this.__graphLayout.fillMode===FillMode.FromSource?(this.__context.lineTo(this.__points[0].x,this.__points[0].y),this.__context.fill("evenodd")):this.__graphLayout.fillMode===FillMode.FromFirst&&this.__context.fill();if(this.__graphLayout.markWidth&&this.__graphLayout.markColor&&(this.__context.strokeStyle=this.__graphLayout.markColor,this.__context.lineWidth=this.__graphLayout.markWidth,this.__context.lineCap="square",this.__context.globalAlpha=1,this.__context.setLineDash([]),this.__graphLayout.marks||this.__graphLayout.graphType===GraphType.MarksOnly))if(this.__graphLayout.graphType===GraphType.ExtendedLine&&this.__lineSeries){this.__context.save();let start=0,end=this.__points.length,current="1";for(let i=0,ii=this.__lineSeries.length;i<ii;i++)this.__lineSeries[i].lineStates.filter(ls=>4===parseInt(ls[14],16))&&(this.__lineSeries[i].index>start&&(end=this.__lineSeries[i].index,0===(parseInt(current.substring(14,18),16)&LineState.Invisible)&&this.__renderMarkSegment(start,end-1,current)),start=this.__lineSeries[i].index,current=this.__lineSeries[i].lineStates.find(ls=>4===parseInt(ls[14],16)));start<this.__points.length&&0===(parseInt(current.substring(14,18),16)&LineState.Invisible)&&this.__renderMarkSegment(start,this.__points.length-1,current)}else{this.__context.beginPath();for(let i=0,ii=this.__points.length;i<ii;i++)this.__context.moveTo(this.__points[i].x,this.__points[i].y),this.__context.lineTo(this.__points[i].x,this.__points[i].y);this.__context.stroke()}if(this.__graphLayout.showStartCap&&this.__graphLayout.capSize&&this.__graphLayout.capColor){let startCapS=this.__points[this.__points.length-2],startCapE=this.__points[this.__points.length-1],dx=startCapE.x-startCapS.x,dy=startCapE.y-startCapS.y,ang=Math.atan2(dy,dx);this.__context.fillStyle=this.__graphLayout.capColor,this.__context.save(),this.__context.translate(startCapE.x,startCapE.y),this.__context.rotate(ang),this.__context.beginPath(),this.__context.moveTo(0,this.__graphLayout.capSize),this.__context.lineTo(0,-this.__graphLayout.capSize),this.__context.lineTo(this.__graphLayout.capSize,0),this.__context.fill(),this.__context.restore()}this.__graphLayout.showEndCap&&this.__graphLayout.capSize&&this.__graphLayout.capColor&&(this.__context.beginPath(),this.__context.fillStyle=this.__graphLayout.capColor,this.__context.arc(this.__points[0].x,this.__points[0].y,this.__graphLayout.capSize/2,0,2*Math.PI),this.__context.fill())}}__renderLineSegment(start,end,current){if(this.__context&&this.__points){if(this.__context.restore(),this.__context.beginPath(),this.__context.save(),0!==(parseInt(current.substring(14,18),16)&LineState.Invisible))return;(parseInt(current.substring(14,18),16)&LineState.BoldLine)===LineState.BoldLine&&(this.__context.lineWidth=14.5*this.__context.lineWidth),(parseInt(current.substring(14,18),16)&LineState.MediumBoldLine)===LineState.MediumBoldLine&&(this.__context.lineWidth=7*this.__context.lineWidth),(parseInt(current.substring(14,18),16)&LineState.Dashed)===LineState.Dashed&&this.__context.setLineDash([2,5]),(parseInt(current.substring(14,18),16)&LineState.ApplyToLine)===LineState.ApplyToLine&&0!==parseInt(current.substring(5,14),16)&&(this.__context.strokeStyle="#"+current.substring(8,14),this.__context.globalAlpha=parseInt(current.substring(6,8),16)/255);for(let i=start,ii=end;i<=ii;i++)i===start?this.__context.moveTo(this.__points[i].x,this.__points[i].y):this.__context.lineTo(this.__points[i].x,this.__points[i].y);this.__context.stroke()}}__renderMarkSegment(start,end,current){if(this.__context&&this.__points){if(this.__context.restore(),this.__context.beginPath(),this.__context.save(),(parseInt(current.substring(14,18),16)&LineState.BoldMark)===LineState.BoldMark&&(this.__context.lineWidth=14.5*this.__context.lineWidth),(parseInt(current.substring(14,18),16)&LineState.MediumBoldMark)===LineState.MediumBoldMark&&(this.__context.lineWidth=7*this.__context.lineWidth),(parseInt(current.substring(14,18),16)&LineState.ApplyToMark)===LineState.ApplyToMark&&0!==parseInt(current.substring(5,14),16)&&(this.__context.strokeStyle="#"+current.substring(8,14),this.__context.globalAlpha=parseInt(current.substring(6,8),16)/255),this.__graphLayout&&this.__graphLayout.markWidth&&this.__graphLayout.markColor){this.__context.beginPath();for(let i=start,ii=end;i<=ii;i++)this.__context.moveTo(this.__points[i].x,this.__points[i].y),this.__context.lineTo(this.__points[i].x,this.__points[i].y)}this.__context.stroke()}}__renderFillSegment(start,end,current){if(this.__context&&this.__points){this.__context.restore(),this.__context.beginPath(),this.__context.save(),(parseInt(current.substring(14,18),16)&LineState.ApplyToFillArea)===LineState.ApplyToFillArea&&0!==parseInt(current.substring(5,14),16)&&(this.__context.fillStyle="#"+current.substring(8,14),this.__context.globalAlpha=parseInt(current.substring(6,8),16)/255),0!==(parseInt(current.substring(14,18),16)&LineState.Invisible)&&(this.__context.globalAlpha=0),this.__context.moveTo(this.__points[end].x,this.__points[end].y);for(let i=end+1,ii=start;i<=ii;i++)this.__context.lineTo(this.__points[i].x,this.__points[i].y);this.__graphLayout&&(this.__graphLayout.fillMode===FillMode.FromTop?(this.__context.lineTo(this.__points[start].x,this.__gridSizeLayout.position.y),this.__context.lineTo(this.__points[end].x,this.__gridSizeLayout.position.y),this.__context.lineTo(this.__points[end].x,this.__points[end].y),this.__context.fill()):this.__graphLayout.fillMode===FillMode.FromBottom?(this.__context.lineTo(this.__points[start].x,this.__gridSizeLayout.position.y+this.__gridSizeLayout.dimensions.height),this.__context.lineTo(this.__points[end].x,this.__gridSizeLayout.position.y+this.__gridSizeLayout.dimensions.height),this.__context.lineTo(this.__points[end].x,this.__points[end].y),this.__context.fill()):this.__graphLayout.fillMode===FillMode.FromHorizontalZero&&this.__zeroPoint&&(this.__context.lineTo(this.__points[start].x,this.__zeroPoint.y),this.__context.lineTo(this.__points[end].x,this.__zeroPoint.y),this.__context.fill()))}}setPoints(points){this.__points=points}setZeroPoint(zeroPoint){this.__zeroPoint=zeroPoint}setLineSeries(lineSeries){this.__lineSeries=lineSeries}}